# Carpoel-at-age-three-DQN-algorithm

## æœ¬ä»£ç åŸºäºAIStudioç¯å¢ƒè¿è¡Œï¼ï¼ï¼
æ·±åº¦å­¦ä¹ å…¥é—¨ | ä¸‰å²åœ¨é£æ¡¨å¸¦ä½ å…¥é—¨æ·±åº¦å­¦ä¹ â€”Carpoelï¼Œåˆ©ç”¨PARLå¤ç°åŸºäºç¥ç»ç½‘ç»œä¸DQNç®—æ³•ï¼ˆçœŸçš„æ˜¯0åŸºç¡€ï¼‰
# æ·±åº¦å­¦ä¹ å…¥é—¨ | ä¸‰å²åœ¨é£æ¡¨å¸¦ä½ å…¥é—¨æ·±åº¦å­¦ä¹ â€”Carpoelï¼Œåˆ©ç”¨PARLå¤ç°åŸºäºç¥ç»ç½‘ç»œä¸DQNç®—æ³•ï¼ˆçœŸçš„æ˜¯0åŸºç¡€ï¼‰
å¤§å®¶å¥½ï¼Œè¿™é‡Œæ˜¯ä¸‰å²ï¼Œä¼—æ‰€å‘¨çŸ¥ä¸‰å²æ˜¯ç¼–ç¨‹å±Šå°ç™½ï¼Œä¸ºäº†ç»™å¤§å®¶è´¡çŒ®ä¸€ä¸ªâ€œçˆ¬å±±â€çš„æ¨¡æ¿ï¼Œ
ä¸‰å²åˆ©ç”¨æœ€åŸºç¡€çš„æ·±åº¦å­¦ä¹ â€œhello worldâ€é¡¹ç›®ç»™å¤§å®¶è§£æï¼ŒåŠåšç¤ºèŒƒã€‚
ä¸‰å²è€è§„çŸ©ï¼Œç™½è¯ï¼Œç®€å•ï¼Œå…¥é—¨ï¼ŒåŸºç¡€
å¦‚æœæœ‰ä»€ä¹ˆä¸å‡†ç¡®ï¼Œä¸æ­£ç¡®çš„åœ°æ–¹å¸Œæœ›å¤§å®¶å¯ä»¥æå‡ºæ¥ï¼
ï¼ˆä»£ç æºäº[å¼ºåŒ–å­¦ä¹ 7æ—¥æ‰“å¡è¥-ä¸–ç•Œå† å†›å¸¦ä½ ä»é›¶å®è·µ>PARLå¼ºåŒ–å­¦ä¹ å…¬å¼€è¯¾Lesson3_DQN](https://aistudio.baidu.com/aistudio/projectdetail/569647)ï¼‰
* ä»¥ä¸‹é¡¹ç›®é€‚ç”¨äºCPUç¯å¢ƒ
## å‚è€ƒèµ„æ–™
* Bç«™è§†é¢‘åœ°å€ï¼š[https://www.bilibili.com/video/bv1v54y1v7Qf](https://www.bilibili.com/video/bv1v54y1v7Qf)
* AI ç¤¾åŒºæ–‡ç« åœ°å€ï¼š[https://ai.baidu.com/forum/topic/show/962531](https://ai.baidu.com/forum/topic/show/962531)
* CSDNæ–‡ç« åœ°å€ï¼š[https://editor.csdn.net/md?articleId=107393006](https://editor.csdn.net/md?articleId=107393006)
* ä¸‰å²æ¨æ–‡åœ°å€ï¼š[https://mp.weixin.qq.com/s/6-6RR0XuvTNuXKhX7fFXaQ](https://mp.weixin.qq.com/s/6-6RR0XuvTNuXKhX7fFXaQ)
* å‚è€ƒè®ºæ–‡ï¼š[https://www.nature.com/articles/nature14236](https://www.nature.com/articles/nature14236)
* DQNgithubåœ°å€ï¼š[https://github.com/PaddlePaddle/PARL/tree/develop/examples](https://github.com/PaddlePaddle/PARL/tree/develop/examples)
* å‚è€ƒè§†é¢‘ï¼š[https://www.bilibili.com/video/BV1yv411i7xd?p=12](https://www.bilibili.com/video/BV1yv411i7xd?p=12)
* Carpoelå‚è€ƒèµ„æ–™ï¼š[https://gym.openai.com/envs/CartPole-v1/](https://gym.openai.com/envs/CartPole-v1/)
* PARLå®˜æ–¹åœ°å€ï¼š[https://github.com/PaddlePaddle/PARL](https://github.com/PaddlePaddle/PARL)

é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±å¼€å§‹çˆ¬å±±å§ï¼Œè®°å¾—å”±ç€å°ç™½èˆ¹ç„¶åå½•åƒå‘¦ï¼Œä¸‰å²ä¼šå¸®ä½ è°ƒæ•´ä¸€ä¸‹jioçš„ä½ç½®çš„ã€æ»‘ç¨½ã€‘


### ç¯å¢ƒé¢„è®¾
æ ¹æ®å®é™…æƒ…å†µæŠŠAI Studioçš„ç¯å¢ƒè¿›è¡Œä¿®æ”¹ä½¿å…¶æ›´åŠ ç¬¦åˆä»£ç çš„è¿è¡Œã€‚


```python
!pip uninstall -y parl  # è¯´æ˜ï¼šAIStudioé¢„è£…çš„parlç‰ˆæœ¬å¤ªè€ï¼Œå®¹æ˜“è·Ÿå…¶ä»–åº“äº§ç”Ÿå…¼å®¹æ€§å†²çªï¼Œå»ºè®®å…ˆå¸è½½
!pip uninstall -y pandas scikit-learn # æç¤ºï¼šåœ¨AIStudioä¸­å¸è½½è¿™ä¸¤ä¸ªåº“å†import parlå¯é¿å…warningæç¤ºï¼Œä¸å¸è½½ä¹Ÿä¸å½±å“parlçš„ä½¿ç”¨

!pip install gym
!pip install paddlepaddle==1.6.3
!pip install parl==1.3.1

# å»ºè®®ä¸‹è½½paddleç³»åˆ—äº§å“æ—¶æ·»åŠ ç™¾åº¦æº -i https://mirror.baidu.com/pypi/simple
# python -m pip install paddlepaddle -i https://mirror.baidu.com/pypi/simple
# pip install parl==1.3.1  -i https://mirror.baidu.com/pypi/simple

# è¯´æ˜ï¼šå®‰è£…æ—¥å¿—ä¸­å‡ºç°ä¸¤æ¡çº¢è‰²çš„å…³äº paddlehub å’Œ visualdl çš„ ERROR ä¸parlæ— å…³ï¼Œå¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“ä½¿ç”¨
```

    Uninstalling parl-1.1.2:
      Successfully uninstalled parl-1.1.2
    Uninstalling pandas-0.23.4:
      Successfully uninstalled pandas-0.23.4
    Uninstalling scikit-learn-0.20.0:
      Successfully uninstalled scikit-learn-0.20.0
    Looking in indexes: https://pypi.mirrors.ustc.edu.cn/simple/
    Requirement already satisfied: gym in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (0.12.1)
    Requirement already satisfied: requests>=2.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from gym) (2.22.0)
    Requirement already satisfied: six in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from gym) (1.15.0)
    Requirement already satisfied: numpy>=1.10.4 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from gym) (1.16.4)
    Requirement already satisfied: pyglet>=1.2.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from gym) (1.4.5)
    Requirement already satisfied: scipy in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from gym) (1.3.0)
    Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.0->gym) (2019.9.11)
    Requirement already satisfied: chardet<3.1.0,>=3.0.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.0->gym) (3.0.4)
    Requirement already satisfied: idna<2.9,>=2.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.0->gym) (2.8)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.0->gym) (1.25.6)
    Requirement already satisfied: future in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pyglet>=1.2.0->gym) (0.18.0)
    Looking in indexes: https://pypi.mirrors.ustc.edu.cn/simple/
    Collecting paddlepaddle==1.6.3
    [?25l  Downloading https://mirrors.tuna.tsinghua.edu.cn/pypi/web/packages/96/28/e72bebb3c9b3d98eb9b15d9f6d85150f3cbd63e695e59882ff9f04846686/paddlepaddle-1.6.3-cp37-cp37m-manylinux1_x86_64.whl (90.9MB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 90.9MB 488kB/s eta 0:00:011    |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                | 44.0MB 481kB/s eta 0:01:38
    [?25hRequirement already satisfied: nltk; python_version >= "3.5" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (3.4.5)
    Requirement already satisfied: prettytable in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (0.7.2)
    Requirement already satisfied: six in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (1.15.0)
    Requirement already satisfied: protobuf>=3.1.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (3.10.0)
    Requirement already satisfied: numpy>=1.12; python_version >= "3.5" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (1.16.4)
    Requirement already satisfied: scipy; python_version >= "3.5" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (1.3.0)
    Requirement already satisfied: objgraph in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (3.4.1)
    Requirement already satisfied: decorator in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (4.4.0)
    Requirement already satisfied: matplotlib; python_version >= "3.6" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (2.2.3)
    Requirement already satisfied: Pillow in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (7.1.2)
    Requirement already satisfied: opencv-python in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (4.1.1.26)
    Requirement already satisfied: requests>=2.20.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (2.22.0)
    Requirement already satisfied: pyyaml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (5.1.2)
    Requirement already satisfied: funcsigs in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (1.0.2)
    Requirement already satisfied: rarfile in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (3.1)
    Requirement already satisfied: graphviz in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddlepaddle==1.6.3) (0.13)
    Requirement already satisfied: setuptools in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from protobuf>=3.1.0->paddlepaddle==1.6.3) (41.4.0)
    Requirement already satisfied: cycler>=0.10 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib; python_version >= "3.6"->paddlepaddle==1.6.3) (0.10.0)
    Requirement already satisfied: kiwisolver>=1.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib; python_version >= "3.6"->paddlepaddle==1.6.3) (1.1.0)
    Requirement already satisfied: pytz in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib; python_version >= "3.6"->paddlepaddle==1.6.3) (2019.3)
    Requirement already satisfied: python-dateutil>=2.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib; python_version >= "3.6"->paddlepaddle==1.6.3) (2.8.0)
    Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,>=2.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib; python_version >= "3.6"->paddlepaddle==1.6.3) (2.4.2)
    Requirement already satisfied: idna<2.9,>=2.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.20.0->paddlepaddle==1.6.3) (2.8)
    Requirement already satisfied: chardet<3.1.0,>=3.0.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.20.0->paddlepaddle==1.6.3) (3.0.4)
    Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.20.0->paddlepaddle==1.6.3) (2019.9.11)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests>=2.20.0->paddlepaddle==1.6.3) (1.25.6)
    Installing collected packages: paddlepaddle
      Found existing installation: paddlepaddle 1.8.0
        Uninstalling paddlepaddle-1.8.0:
          Successfully uninstalled paddlepaddle-1.8.0
    Successfully installed paddlepaddle-1.6.3
    Looking in indexes: https://pypi.mirrors.ustc.edu.cn/simple/
    Collecting parl==1.3.1
    [?25l  Downloading https://mirrors.tuna.tsinghua.edu.cn/pypi/web/packages/62/79/590af38a920792c71afb73fad7583967928b4d0ba9fca76250d935c7fda8/parl-1.3.1-py2.py3-none-any.whl (521kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 522kB 17.8MB/s eta 0:00:01
    [?25hRequirement already satisfied: tb-nightly==1.15.0a20190801 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.15.0a20190801)
    Requirement already satisfied: visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (2.0.0b4)
    Requirement already satisfied: pyzmq==18.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (18.0.1)
    Requirement already satisfied: flask>=1.0.4 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.1.1)
    Collecting flask-cors (from parl==1.3.1)
      Downloading https://mirrors.tuna.tsinghua.edu.cn/pypi/web/packages/78/38/e68b11daa5d613e3a91e4bf3da76c94ac9ee0d9cd515af9c1ab80d36f709/Flask_Cors-3.0.8-py2.py3-none-any.whl
    Requirement already satisfied: click in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (7.0)
    Collecting psutil>=5.6.2 (from parl==1.3.1)
    [?25l  Downloading https://mirrors.tuna.tsinghua.edu.cn/pypi/web/packages/aa/3e/d18f2c04cf2b528e18515999b0c8e698c136db78f62df34eee89cee205f1/psutil-5.7.2.tar.gz (460kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 460kB 52.1MB/s eta 0:00:01
    [?25hRequirement already satisfied: tensorboardX==1.8 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.8)
    Requirement already satisfied: pyarrow==0.13.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (0.13.0)
    Requirement already satisfied: scipy>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.3.0)
    Requirement already satisfied: termcolor>=1.1.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.1.0)
    Requirement already satisfied: cloudpickle==1.2.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from parl==1.3.1) (1.2.1)
    Requirement already satisfied: absl-py>=0.4 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (0.8.1)
    Requirement already satisfied: six>=1.10.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (1.15.0)
    Requirement already satisfied: grpcio>=1.6.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (1.26.0)
    Requirement already satisfied: wheel>=0.26; python_version >= "3" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (0.33.6)
    Requirement already satisfied: setuptools>=41.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (41.4.0)
    Requirement already satisfied: werkzeug>=0.11.15 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (0.16.0)
    Requirement already satisfied: markdown>=2.6.8 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (3.1.1)
    Requirement already satisfied: protobuf>=3.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (3.10.0)
    Requirement already satisfied: numpy>=1.12.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from tb-nightly==1.15.0a20190801->parl==1.3.1) (1.16.4)
    Requirement already satisfied: requests in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.22.0)
    Requirement already satisfied: pre-commit in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.21.0)
    Requirement already satisfied: flake8>=3.7.9 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (3.8.2)
    Requirement already satisfied: Flask-Babel>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.0.0)
    Requirement already satisfied: opencv-python in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (4.1.1.26)
    Requirement already satisfied: Pillow>=7.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (7.1.2)
    Requirement already satisfied: itsdangerous>=0.24 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.0.4->parl==1.3.1) (1.1.0)
    Requirement already satisfied: Jinja2>=2.10.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.0.4->parl==1.3.1) (2.10.3)
    Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2019.9.11)
    Requirement already satisfied: idna<2.9,>=2.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.8)
    Requirement already satisfied: chardet<3.1.0,>=3.0.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (3.0.4)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.25.6)
    Requirement already satisfied: importlib-metadata; python_version < "3.8" in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (0.23)
    Requirement already satisfied: identify>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.4.10)
    Requirement already satisfied: nodeenv>=0.11.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.3.4)
    Requirement already satisfied: cfgv>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.0.1)
    Requirement already satisfied: aspy.yaml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (1.3.0)
    Requirement already satisfied: virtualenv>=15.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (16.7.9)
    Requirement already satisfied: toml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (0.10.0)
    Requirement already satisfied: pyyaml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (5.1.2)
    Requirement already satisfied: mccabe<0.7.0,>=0.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (0.6.1)
    Requirement already satisfied: pycodestyle<2.7.0,>=2.6.0a1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.6.0)
    Requirement already satisfied: pyflakes<2.3.0,>=2.2.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.2.0)
    Requirement already satisfied: pytz in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2019.3)
    Requirement already satisfied: Babel>=2.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (2.8.0)
    Requirement already satisfied: MarkupSafe>=0.23 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Jinja2>=2.10.1->flask>=1.0.4->parl==1.3.1) (1.1.1)
    Requirement already satisfied: zipp>=0.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from importlib-metadata; python_version < "3.8"->pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (0.6.0)
    Requirement already satisfied: more-itertools in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from zipp>=0.5->importlib-metadata; python_version < "3.8"->pre-commit->visualdl>=2.0.0b; python_version >= "3" and platform_system == "Linux"->parl==1.3.1) (7.2.0)
    Building wheels for collected packages: psutil
      Building wheel for psutil (setup.py) ... [?25ldone
    [?25h  Created wheel for psutil: filename=psutil-5.7.2-cp37-cp37m-linux_x86_64.whl size=268459 sha256=ef019c256f341f219f0260fa4acfe2863e8f0bf1f96ed95b3f910a2a4c44a74c
      Stored in directory: /home/aistudio/.cache/pip/wheels/a8/74/a2/9f54383a7c48678163f965a5d2f4acb794417e60ab0d7351f8
    Successfully built psutil
    Installing collected packages: flask-cors, psutil, parl
    Successfully installed flask-cors-3.0.8 parl-1.3.1 psutil-5.7.2


### Step2  å¯¼å…¥ä¾èµ–
å¦‚æœä¾èµ–å¯¼å…¥å¤±è´¥æœ‰å¯èƒ½æ²¡æœ‰ä¸‹è½½ç¬¬ä¸‰æ–¹åº“å¯ä»¥åœ¨æ­¤å‰åŠ ä¸Šä»£ç å—
ï¼pip instudio ç¬¬ä¸‰æ–¹åº“å 

å¦‚æœå®‰è£…å¤±è´¥å¯ä»¥åŠ ä¸Šé•œåƒ

![](https://ai-studio-static-online.cdn.bcebos.com/8ee07cbb24874e96bdac93b07e3a22e3b6b465981c904129990af727701bd0b0)
```
é•œåƒæºåœ°å€ï¼š

ç™¾åº¦ï¼šhttps://mirror.baidu.com/pypi/simple

æ¸…åï¼šhttps://pypi.tuna.tsinghua.edu.cn/simple

é˜¿é‡Œäº‘ï¼šhttp://mirrors.aliyun.com/pypi/simple/

ä¸­å›½ç§‘æŠ€å¤§å­¦ https://pypi.mirrors.ustc.edu.cn/simple/

åä¸­ç†å·¥å¤§å­¦ï¼šhttp://pypi.hustunique.com/

å±±ä¸œç†å·¥å¤§å­¦ï¼šhttp://pypi.sdutlinux.org/

è±†ç“£ï¼šhttp://pypi.douban.com/simple/

ä¾‹ï¼š!pip instudio jieba -i https://mirror.baidu.com/pypi/simple
```


```python
import parl
from parl import layers
import paddle.fluid as fluid
import copy
import numpy as np
import os
import gym
from parl.utils import logger
```

# æµç¨‹è§£æ
![](https://ai-studio-static-online.cdn.bcebos.com/25f4800e0c3b44bc9ddc908a4d3dba1793dc74f0f5a045e799771f0466b88e5b)


### Step3 è®¾ç½®è¶…å‚æ•°


```python
LEARN_FREQ = 5 # è®­ç»ƒé¢‘ç‡ï¼Œä¸éœ€è¦æ¯ä¸€ä¸ªstepéƒ½learnï¼Œæ”’ä¸€äº›æ–°å¢ç»éªŒåå†learnï¼Œæé«˜æ•ˆç‡
MEMORY_SIZE = 20000    # replay memoryçš„å¤§å°ï¼Œè¶Šå¤§è¶Šå ç”¨å†…å­˜
MEMORY_WARMUP_SIZE = 200  # replay_memory é‡Œéœ€è¦é¢„å­˜ä¸€äº›ç»éªŒæ•°æ®ï¼Œå†å¼€å¯è®­ç»ƒ
BATCH_SIZE = 32   # æ¯æ¬¡ç»™agent learnçš„æ•°æ®æ•°é‡ï¼Œä»replay memoryéšæœºé‡Œsampleä¸€æ‰¹æ•°æ®å‡ºæ¥
LEARNING_RATE = 0.001 # å­¦ä¹ ç‡
GAMMA = 0.99 # reward çš„è¡°å‡å› å­ï¼Œä¸€èˆ¬å– 0.9 åˆ° 0.999 ä¸ç­‰
```

# æ­å»ºPARL
ä»€ä¹ˆæ˜¯PARLå‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹å®˜æ–¹æ–‡æ¡£æ€ä¹ˆè¯´

![é£æ¡¨å®˜ç½‘æè¿°](https://ai-studio-static-online.cdn.bcebos.com/1f72929e036549d493dee85c2834b8a98e330c4ac6a447f08b647cab09e12bfa)         é£æ¡¨å®˜ç½‘æè¿°
![PARL GitHubæè¿°](https://ai-studio-static-online.cdn.bcebos.com/9a19623bdf41411ca07c089d3cf0f64752e0eb51a58a47e694bc4e4614079078)       PARL GitHubæè¿°

* PARLä¸»è¦æ˜¯åŸºäºModelã€Algorithmã€Agentä¸‰ä¸ªä»£ç å—æ¥å®ç°ï¼Œå…¶ä¸­Modelå’ŒAgentæ˜¯ç”¨æˆ·è‡ªå®šä¹‰æ“ä½œã€‚
* Modelï¼šæ˜¯ç½‘ç»œç»“æ„ï¼šè¦ä¸‰å±‚ç½‘ç»œè¿˜æ˜¯å››å±‚ç½‘ç»œéƒ½æ˜¯åœ¨Modelä¸­å»å®šä¹‰ï¼ˆä¸‹æ–‡æ˜¯ä¸‰å±‚çš„ç½‘ç»œç»“æ„ï¼‰
* Agentï¼šæ˜¯PARLä¸ç¯å¢ƒçš„ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡å¯¹æ¨¡æ¿çš„ä¿®æ”¹å³å¯è¿ç”¨åˆ°å„ä¸ªä¸åŒçš„ç¯å¢ƒä¸­å»ã€‚

* è‡³äºAlgorithmæ˜¯å†…éƒ¨å·²ç»å°è£…å¥½äº†çš„ï¼Œç›´æ¥åŠ å…¥å‚æ•°è¿è¡Œå³å¯ï¼Œä¸»è¦æ˜¯ç®—æ³•çš„æ¨¡å—çš„å±•ç°


### Step4 æ­å»ºModelã€Algorithmã€Agentæ¶æ„
* `Agent`æŠŠäº§ç”Ÿçš„æ•°æ®ä¼ ç»™`algorithm`ï¼Œ`algorithm`æ ¹æ®`model`çš„æ¨¡å‹ç»“æ„è®¡ç®—å‡º`Loss`ï¼Œä½¿ç”¨`SGD`æˆ–è€…å…¶ä»–ä¼˜åŒ–å™¨ä¸æ–­çš„ä¼˜åŒ–ï¼Œ`PARL`è¿™ç§æ¶æ„å¯ä»¥å¾ˆæ–¹ä¾¿çš„åº”ç”¨åœ¨å„ç±»æ·±åº¦å¼ºåŒ–å­¦ä¹ é—®é¢˜ä¸­ã€‚

#### ï¼ˆ1ï¼‰Model
* `Model`ç”¨æ¥å®šä¹‰å‰å‘(`Forward`)ç½‘ç»œï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±çš„å®šåˆ¶è‡ªå·±çš„ç½‘ç»œç»“æ„ã€‚


```python
class Model(parl.Model):
    def __init__(self, act_dim):
        hid1_size = 128
        hid2_size = 128
        # 3å±‚å…¨è¿æ¥ç½‘ç»œ
        self.fc1 = layers.fc(size=hid1_size, act='relu')
        self.fc2 = layers.fc(size=hid2_size, act='relu')
        self.fc3 = layers.fc(size=act_dim, act=None)

    def value(self, obs):
        # å®šä¹‰ç½‘ç»œ
        # è¾“å…¥stateï¼Œè¾“å‡ºæ‰€æœ‰actionå¯¹åº”çš„Qï¼Œ[Q(s,a1), Q(s,a2), Q(s,a3)...]
        h1 = self.fc1(obs)
        h2 = self.fc2(h1)
        Q = self.fc3(h2)
        return Q
```

## Qç®—æ³•çš„â€œè—èº«ä¹‹åœ°â€
###  ä¼˜åŠ¿
DQNç®—æ³•è¾ƒæ™®é€šç®—æ³•åœ¨ç»éªŒå›æ”¾å’Œå›ºå®šQç›®æ ‡æœ‰äº†è¾ƒå¤§çš„æ”¹è¿›

* 1ã€ç»éªŒå›æ”¾ï¼šä»–å……åˆ†åˆ©ç”¨äº†off-colicpçš„ä¼˜åŠ¿ï¼Œé€šè¿‡è®­ç»ƒæŠŠç»“æœï¼ˆæˆç»©ï¼‰å­˜å…¥Qè¡¨æ ¼ï¼Œç„¶åéšæœºä»è¡¨æ ¼ä¸­å–å‡ºä¸€æ¡ç»“æœè¿›è¡Œä¼˜åŒ–ã€‚è¿™æ ·å­ä¸€æ–¹é¢å¯ä»¥ï¼šå‡å°‘æ ·æœ¬ä¹‹é—´çš„å…³è”æ€§å¦ä¸€æ–¹é¢ï¼šæé«˜æ ·æœ¬çš„åˆ©ç”¨ç‡
æ³¨ï¼šè®­ç»ƒç»“æœä¼šå­˜è¿›Qè¡¨æ ¼ï¼Œå½“Qè¡¨æ ¼æ»¡äº†ä»¥åï¼Œå­˜è¿›æ¥çš„æ•°æ®ä¼šæŠŠæœ€æ—©å­˜è¿›å»çš„æ•°æ®â€œæŒ¤å‡ºå»â€ï¼ˆå¼¹å‡ºï¼‰
* 2ã€å›ºå®šQç›®æ ‡ä»–è§£å†³äº†ç®—æ³•æ›´æ–°ä¸å¹³ç¨³çš„é—®é¢˜ã€‚
å’Œç›‘ç£å­¦ä¹ åšæ¯”è¾ƒï¼Œç›‘ç£å­¦ä¹ çš„æœ€ç»ˆå€¼è¦é€¼è¿‘å®é™…ç»“æœï¼Œè¿™ä¸ªç»“æœæ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„DQNå´ä¸æ˜¯ï¼Œä»–çš„ç›®æ ‡å€¼æ˜¯ç»è¿‡ç¥ç»ç½‘ç»œä»¥åçš„ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼æ˜¯å˜åŠ¨çš„ä¸å¥½æ‹Ÿåˆï¼Œæ€ä¹ˆåŠï¼ŒDQNå›¢é˜Ÿæƒ³åˆ°äº†ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ï¼Œè®©è¿™ä¸ªå€¼åœ¨ä¸€å®šæ—¶é—´é‡Œé¢ä¿æŒä¸å˜ï¼Œè¿™æ ·å­è¿™ä¸ªç›®æ ‡å°±å¯ä»¥ç¡®å®šäº†ï¼Œç„¶åç›®æ ‡å€¼æ›´æ–°ä»¥åæ›´åŠ æ¥è¿‘å®é™…ç»“æœï¼Œå¯ä»¥æ›´å¥½çš„è¿›è¡Œè®­ç»ƒã€‚

#### ï¼ˆ2ï¼‰Algorithm
* `Algorithm`Â å®šä¹‰äº†å…·ä½“çš„ç®—æ³•æ¥æ›´æ–°å‰å‘ç½‘ç»œ(`Model`)ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å®šä¹‰æŸå¤±å‡½æ•°æ¥æ›´æ–°`Model`ï¼Œå’Œç®—æ³•ç›¸å…³çš„è®¡ç®—éƒ½æ”¾åœ¨`algorithm`ä¸­ã€‚




```python
# from parl.algorithms import DQN # ä¹Ÿå¯ä»¥ç›´æ¥ä»parlåº“ä¸­å¯¼å…¥DQNç®—æ³•

class DQN(parl.Algorithm):
    def __init__(self, model, act_dim=None, gamma=None, lr=None):
        """ DQN algorithm
        
        Args:
            model (parl.Model): å®šä¹‰Qå‡½æ•°çš„å‰å‘ç½‘ç»œç»“æ„
            act_dim (int): actionç©ºé—´çš„ç»´åº¦ï¼Œå³æœ‰å‡ ä¸ªaction
            gamma (float): rewardçš„è¡°å‡å› å­
            lr (float): learning rate å­¦ä¹ ç‡.
        """
        self.model = model
        self.target_model = copy.deepcopy(model)

        assert isinstance(act_dim, int)
        assert isinstance(gamma, float)
        assert isinstance(lr, float)
        self.act_dim = act_dim
        self.gamma = gamma
        self.lr = lr

    def predict(self, obs):
        """ ä½¿ç”¨self.modelçš„valueç½‘ç»œæ¥è·å– [Q(s,a1),Q(s,a2),...]
        """
        return self.model.value(obs)

    def learn(self, obs, action, reward, next_obs, terminal):
        """ ä½¿ç”¨DQNç®—æ³•æ›´æ–°self.modelçš„valueç½‘ç»œ
        """
        # ä»target_modelä¸­è·å– max Q' çš„å€¼ï¼Œç”¨äºè®¡ç®—target_Q
        next_pred_value = self.target_model.value(next_obs)
        best_v = layers.reduce_max(next_pred_value, dim=1)
        best_v.stop_gradient = True  # é˜»æ­¢æ¢¯åº¦ä¼ é€’
        terminal = layers.cast(terminal, dtype='float32')
        target = reward + (1.0 - terminal) * self.gamma * best_v

        pred_value = self.model.value(obs)  # è·å–Qé¢„æµ‹å€¼
        # å°†actionè½¬onehotå‘é‡ï¼Œæ¯”å¦‚ï¼š3 => [0,0,0,1,0]
        action_onehot = layers.one_hot(action, self.act_dim)
        action_onehot = layers.cast(action_onehot, dtype='float32')
        # ä¸‹é¢ä¸€è¡Œæ˜¯é€å…ƒç´ ç›¸ä¹˜ï¼Œæ‹¿åˆ°actionå¯¹åº”çš„ Q(s,a)
        # æ¯”å¦‚ï¼špred_value = [[2.3, 5.7, 1.2, 3.9, 1.4]], action_onehot = [[0,0,0,1,0]]
        #  ==> pred_action_value = [[3.9]]
        pred_action_value = layers.reduce_sum(
            layers.elementwise_mul(action_onehot, pred_value), dim=1)

        # è®¡ç®— Q(s,a) ä¸ target_Qçš„å‡æ–¹å·®ï¼Œå¾—åˆ°loss
        cost = layers.square_error_cost(pred_action_value, target)
        cost = layers.reduce_mean(cost)
        optimizer = fluid.optimizer.Adam(learning_rate=self.lr)  # ä½¿ç”¨Adamä¼˜åŒ–å™¨
        optimizer.minimize(cost)
        return cost

    def sync_target(self):
        """ æŠŠ self.model çš„æ¨¡å‹å‚æ•°å€¼åŒæ­¥åˆ° self.target_model
        """
        self.model.sync_weights_to(self.target_model)

```

#### ï¼ˆ3ï¼‰Agent
* `Agent`Â è´Ÿè´£ç®—æ³•ä¸ç¯å¢ƒçš„äº¤äº’ï¼Œåœ¨äº¤äº’è¿‡ç¨‹ä¸­æŠŠç”Ÿæˆçš„æ•°æ®æä¾›ç»™`Algorithm`æ¥æ›´æ–°æ¨¡å‹(`Model`)ï¼Œæ•°æ®çš„é¢„å¤„ç†æµç¨‹ä¹Ÿä¸€èˆ¬å®šä¹‰åœ¨è¿™é‡Œã€‚


```python
class Agent(parl.Agent):
    def __init__(self,
                 algorithm,
                 obs_dim,
                 act_dim,
                 e_greed=0.1,
                 e_greed_decrement=0):
        assert isinstance(obs_dim, int)
        assert isinstance(act_dim, int)
        self.obs_dim = obs_dim
        self.act_dim = act_dim
        super(Agent, self).__init__(algorithm)

        self.global_step = 0
        self.update_target_steps = 200  # æ¯éš”200ä¸ªtraining stepså†æŠŠmodelçš„å‚æ•°å¤åˆ¶åˆ°target_modelä¸­

        self.e_greed = e_greed  # æœ‰ä¸€å®šæ¦‚ç‡éšæœºé€‰å–åŠ¨ä½œï¼Œæ¢ç´¢
        self.e_greed_decrement = e_greed_decrement  # éšç€è®­ç»ƒé€æ­¥æ”¶æ•›ï¼Œæ¢ç´¢çš„ç¨‹åº¦æ…¢æ…¢é™ä½

    def build_program(self):
        self.pred_program = fluid.Program()
        self.learn_program = fluid.Program()

        with fluid.program_guard(self.pred_program):  # æ­å»ºè®¡ç®—å›¾ç”¨äº é¢„æµ‹åŠ¨ä½œï¼Œå®šä¹‰è¾“å…¥è¾“å‡ºå˜é‡
            obs = layers.data(
                name='obs', shape=[self.obs_dim], dtype='float32')
            self.value = self.alg.predict(obs)

        with fluid.program_guard(self.learn_program):  # æ­å»ºè®¡ç®—å›¾ç”¨äº æ›´æ–°Qç½‘ç»œï¼Œå®šä¹‰è¾“å…¥è¾“å‡ºå˜é‡
            obs = layers.data(
                name='obs', shape=[self.obs_dim], dtype='float32')
            action = layers.data(name='act', shape=[1], dtype='int32')
            reward = layers.data(name='reward', shape=[], dtype='float32')
            next_obs = layers.data(
                name='next_obs', shape=[self.obs_dim], dtype='float32')
            terminal = layers.data(name='terminal', shape=[], dtype='bool')
            self.cost = self.alg.learn(obs, action, reward, next_obs, terminal)

    def sample(self, obs):
        sample = np.random.rand()  # äº§ç”Ÿ0~1ä¹‹é—´çš„å°æ•°
        if sample < self.e_greed:
            act = np.random.randint(self.act_dim)  # æ¢ç´¢ï¼šæ¯ä¸ªåŠ¨ä½œéƒ½æœ‰æ¦‚ç‡è¢«é€‰æ‹©
        else:
            act = self.predict(obs)  # é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ
        self.e_greed = max(
            0.01, self.e_greed - self.e_greed_decrement)  # éšç€è®­ç»ƒé€æ­¥æ”¶æ•›ï¼Œæ¢ç´¢çš„ç¨‹åº¦æ…¢æ…¢é™ä½
        return act

    def predict(self, obs):  # é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ
        obs = np.expand_dims(obs, axis=0)
        pred_Q = self.fluid_executor.run(
            self.pred_program,
            feed={'obs': obs.astype('float32')},
            fetch_list=[self.value])[0]
        pred_Q = np.squeeze(pred_Q, axis=0)
        act = np.argmax(pred_Q)  # é€‰æ‹©Qæœ€å¤§çš„ä¸‹æ ‡ï¼Œå³å¯¹åº”çš„åŠ¨ä½œ
        return act

    def learn(self, obs, act, reward, next_obs, terminal):
        # æ¯éš”200ä¸ªtraining stepsåŒæ­¥ä¸€æ¬¡modelå’Œtarget_modelçš„å‚æ•°
        if self.global_step % self.update_target_steps == 0:
            self.alg.sync_target()
        self.global_step += 1

        act = np.expand_dims(act, -1)
        feed = {
            'obs': obs.astype('float32'),
            'act': act.astype('int32'),
            'reward': reward,
            'next_obs': next_obs.astype('float32'),
            'terminal': terminal
        }
        cost = self.fluid_executor.run(
            self.learn_program, feed=feed, fetch_list=[self.cost])[0]  # è®­ç»ƒä¸€æ¬¡ç½‘ç»œ
        return cost
```

### Step5 ReplayMemory
* ç»éªŒæ± ï¼šç”¨äºå­˜å‚¨å¤šæ¡ç»éªŒï¼Œå®ç° ç»éªŒå›æ”¾ã€‚
![](https://ai-studio-static-online.cdn.bcebos.com/340817e194974c24ac63dd569fba336cd500d120729e4354825fb9c3501108ab)



```python
import random
import collections
import numpy as np


class ReplayMemory(object):
    def __init__(self, max_size):
        self.buffer = collections.deque(maxlen=max_size)

    # å¢åŠ ä¸€æ¡ç»éªŒåˆ°ç»éªŒæ± ä¸­
    def append(self, exp):
        self.buffer.append(exp)

    # ä»ç»éªŒæ± ä¸­é€‰å–Næ¡ç»éªŒå‡ºæ¥
    def sample(self, batch_size):
        mini_batch = random.sample(self.buffer, batch_size)
        obs_batch, action_batch, reward_batch, next_obs_batch, done_batch = [], [], [], [], []

        for experience in mini_batch:
            s, a, r, s_p, done = experience
            obs_batch.append(s)
            action_batch.append(a)
            reward_batch.append(r)
            next_obs_batch.append(s_p)
            done_batch.append(done)

        return np.array(obs_batch).astype('float32'), \
            np.array(action_batch).astype('float32'), np.array(reward_batch).astype('float32'),\
            np.array(next_obs_batch).astype('float32'), np.array(done_batch).astype('float32')

    def __len__(self):
        return len(self.buffer)

```

### Step6 Training && Testï¼ˆè®­ç»ƒ&&æµ‹è¯•ï¼‰
![](https://ai-studio-static-online.cdn.bcebos.com/3b9f168ee09a46dc9962decb0d2a60f7d35196d459824b9f923b163a0b4bbe4e)
![](https://ai-studio-static-online.cdn.bcebos.com/4ffa39f252744a3791c04c5d8381824d4f7447a592d4409da658045061bcd0b9)
* è®­ç»ƒå’Œè¯„ä¼°çš„ä¸€ä¸ªæ¨¡å—


```python
# è®­ç»ƒä¸€ä¸ªepisode
def run_episode(env, agent, rpm):
    total_reward = 0
    obs = env.reset()
    step = 0
    while True:
        step += 1
        action = agent.sample(obs)  # é‡‡æ ·åŠ¨ä½œï¼Œæ‰€æœ‰åŠ¨ä½œéƒ½æœ‰æ¦‚ç‡è¢«å°è¯•åˆ°
        next_obs, reward, done, _ = env.step(action)
        rpm.append((obs, action, reward, next_obs, done))

        # train model
        if (len(rpm) > MEMORY_WARMUP_SIZE) and (step % LEARN_FREQ == 0):
            (batch_obs, batch_action, batch_reward, batch_next_obs,
             batch_done) = rpm.sample(BATCH_SIZE)
            train_loss = agent.learn(batch_obs, batch_action, batch_reward,
                                     batch_next_obs,
                                     batch_done)  # s,a,r,s',done

        total_reward += reward
        obs = next_obs
        if done:
            break
    return total_reward


# è¯„ä¼° agent, è·‘ 5 ä¸ªepisodeï¼Œæ€»rewardæ±‚å¹³å‡
def evaluate(env, agent, render=False):
    eval_reward = []
    for i in range(5):
        obs = env.reset()
        episode_reward = 0
        while True:
            action = agent.predict(obs)  # é¢„æµ‹åŠ¨ä½œï¼Œåªé€‰æœ€ä¼˜åŠ¨ä½œ
            obs, reward, done, _ = env.step(action)
            episode_reward += reward
            if render:
                env.render()
            if done:
                break
        eval_reward.append(episode_reward)
    return np.mean(eval_reward)

```

### Step7 åˆ›å»ºç¯å¢ƒå’ŒAgentï¼Œåˆ›å»ºç»éªŒæ± ï¼Œå¯åŠ¨è®­ç»ƒï¼Œä¿å­˜æ¨¡å‹

# ä¸»å‡½æ•°
* è®²ä¸æ¸…ï¼Œç†è¿˜ä¹±ï¼Œçœ‹ä¸€æ³¢å›¾è§£ï¼Œå†·é™å†·é™ï¼ï¼ï¼
![](https://ai-studio-static-online.cdn.bcebos.com/dab5d244b98c41108a84e37b79db0009109ed32d4d734ca7b04b68e2e301da09)
![](https://ai-studio-static-online.cdn.bcebos.com/a297e56a6de045169e4a04391c22aa80bf7cc9d9608446fd97bef4dcd16431c8)
![](https://ai-studio-static-online.cdn.bcebos.com/8bc3b4cd1913479480baa286b120f45b49cb8ac7c36645df8423d873a7bd6d07)



```python
env = gym.make('CartPole-v0')  # CartPole-v0: é¢„æœŸæœ€åä¸€æ¬¡è¯„ä¼°æ€»åˆ† > 180ï¼ˆæœ€å¤§å€¼æ˜¯200ï¼‰
action_dim = env.action_space.n  # CartPole-v0: 2
obs_shape = env.observation_space.shape  # CartPole-v0: (4,)

rpm = ReplayMemory(MEMORY_SIZE)  # DQNçš„ç»éªŒå›æ”¾æ± 

# æ ¹æ®parlæ¡†æ¶æ„å»ºagent
model = Model(act_dim=action_dim)
algorithm = DQN(model, act_dim=action_dim, gamma=GAMMA, lr=LEARNING_RATE)
agent = Agent(
    algorithm,
    obs_dim=obs_shape[0],
    act_dim=action_dim,
    e_greed=0.1,  # æœ‰ä¸€å®šæ¦‚ç‡éšæœºé€‰å–åŠ¨ä½œï¼Œæ¢ç´¢
    e_greed_decrement=1e-6)  # éšç€è®­ç»ƒé€æ­¥æ”¶æ•›ï¼Œæ¢ç´¢çš„ç¨‹åº¦æ…¢æ…¢é™ä½

# åŠ è½½æ¨¡å‹
# save_path = './dqn_model.ckpt'
# agent.restore(save_path)

# å…ˆå¾€ç»éªŒæ± é‡Œå­˜ä¸€äº›æ•°æ®ï¼Œé¿å…æœ€å¼€å§‹è®­ç»ƒçš„æ—¶å€™æ ·æœ¬ä¸°å¯Œåº¦ä¸å¤Ÿ
while len(rpm) < MEMORY_WARMUP_SIZE:
    run_episode(env, agent, rpm)

max_episode = 2000

# å¼€å§‹è®­ç»ƒ
episode = 0
while episode < max_episode:  # è®­ç»ƒmax_episodeä¸ªå›åˆï¼Œtestéƒ¨åˆ†ä¸è®¡ç®—å…¥episodeæ•°é‡
    # train part
    for i in range(0, 50):
        total_reward = run_episode(env, agent, rpm)
        episode += 1

    # test part
    eval_reward = evaluate(env, agent, render=False)  # render=True æŸ¥çœ‹æ˜¾ç¤ºæ•ˆæœ
    logger.info('episode:{}    e_greed:{}   test_reward:{}'.format(
        episode, agent.e_greed, eval_reward))

# è®­ç»ƒç»“æŸï¼Œä¿å­˜æ¨¡å‹
save_path = './dqn_model.ckpt'
agent.save(save_path)
```

    [32m[07-27 18:19:17 MainThread @machine_info.py:88][0m Cannot find available GPU devices, using CPU now.
    [32m[07-27 18:19:17 MainThread @machine_info.py:88][0m Cannot find available GPU devices, using CPU now.
    [32m[07-27 18:19:18 MainThread @machine_info.py:88][0m Cannot find available GPU devices, using CPU now.
    [32m[07-27 18:19:19 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:50    e_greed:0.09930599999999931   test_reward:11.0
    [32m[07-27 18:19:21 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:100    e_greed:0.09877699999999878   test_reward:9.4
    [32m[07-27 18:19:23 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:150    e_greed:0.09828699999999829   test_reward:9.4
    [32m[07-27 18:19:24 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:200    e_greed:0.09781299999999782   test_reward:9.2
    [32m[07-27 18:19:26 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:250    e_greed:0.09733199999999734   test_reward:9.2
    [32m[07-27 18:19:27 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:300    e_greed:0.09683499999999684   test_reward:9.6
    [32m[07-27 18:19:29 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:350    e_greed:0.09634199999999635   test_reward:9.6
    [32m[07-27 18:19:30 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:400    e_greed:0.09583999999999585   test_reward:9.6
    [32m[07-27 18:19:32 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:450    e_greed:0.09533799999999534   test_reward:11.0
    [32m[07-27 18:19:34 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:500    e_greed:0.09476499999999477   test_reward:9.4
    [32m[07-27 18:19:37 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:550    e_greed:0.09395199999999396   test_reward:44.4
    [32m[07-27 18:19:43 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:600    e_greed:0.0921909999999922   test_reward:21.2
    [32m[07-27 18:20:05 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:650    e_greed:0.08648299999998649   test_reward:186.0
    [32m[07-27 18:20:39 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:700    e_greed:0.07723099999997723   test_reward:199.0
    [32m[07-27 18:21:12 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:750    e_greed:0.06832399999996833   test_reward:188.6
    [32m[07-27 18:21:42 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:800    e_greed:0.06003099999996003   test_reward:124.6
    [32m[07-27 18:22:09 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:850    e_greed:0.05293599999995294   test_reward:165.6
    [32m[07-27 18:22:31 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:900    e_greed:0.04666999999994667   test_reward:110.2
    [32m[07-27 18:22:56 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:950    e_greed:0.040123999999940124   test_reward:111.0
    [32m[07-27 18:23:21 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1000    e_greed:0.03343099999993343   test_reward:133.6
    [32m[07-27 18:23:47 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1050    e_greed:0.026627999999926627   test_reward:130.0
    [32m[07-27 18:24:08 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1100    e_greed:0.02101999999992102   test_reward:130.0
    [32m[07-27 18:24:31 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1150    e_greed:0.015293999999915868   test_reward:179.4
    [32m[07-27 18:25:03 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1200    e_greed:0.01   test_reward:183.0
    [32m[07-27 18:25:33 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1250    e_greed:0.01   test_reward:130.8
    [32m[07-27 18:25:59 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1300    e_greed:0.01   test_reward:172.8
    [32m[07-27 18:26:25 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1350    e_greed:0.01   test_reward:152.2
    [32m[07-27 18:26:49 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1400    e_greed:0.01   test_reward:127.8
    [32m[07-27 18:27:19 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1450    e_greed:0.01   test_reward:182.0
    [32m[07-27 18:27:52 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1500    e_greed:0.01   test_reward:120.6
    [32m[07-27 18:28:25 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1550    e_greed:0.01   test_reward:133.6
    [32m[07-27 18:28:45 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1600    e_greed:0.01   test_reward:14.0
    [32m[07-27 18:28:49 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1650    e_greed:0.01   test_reward:15.8
    [32m[07-27 18:29:09 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1700    e_greed:0.01   test_reward:164.2
    [32m[07-27 18:29:47 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1750    e_greed:0.01   test_reward:200.0
    [32m[07-27 18:30:26 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1800    e_greed:0.01   test_reward:200.0
    [32m[07-27 18:31:03 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1850    e_greed:0.01   test_reward:182.4
    [32m[07-27 18:31:40 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1900    e_greed:0.01   test_reward:193.8
    [32m[07-27 18:32:17 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:1950    e_greed:0.01   test_reward:193.4
    [32m[07-27 18:32:53 MainThread @<ipython-input-9-eeec60765889>:38][0m episode:2000    e_greed:0.01   test_reward:170.2


![](https://ai-studio-static-online.cdn.bcebos.com/94a7460d1da44164a7805c5680a2779689b1dc4c78494104aa3d2bda075411fa)


# è¿è¡Œç»å†
è¿™ä¸€ä¸²ä»£ç æ˜¯ä»è¯¾ä»¶ä¸Šcopyä¸‹æ¥çš„ï¼Œæ‰€ä»¥é‡Œé¢çš„å‚æ•°åŠæ•°æ®éƒ½æ˜¯å·²ç»è°ƒæ•´å¥½äº†çš„ï¼Œä½†æ˜¯åœ¨çº¿ä¸‹è·‘æ•°æ®å‘ç°æ¯ä¸€æ¬¡è·‘ä¹Ÿå¹¶éåˆ°æœ€åéƒ½æ˜¯200ä¹Ÿå°±æ˜¯æ¯ä¸€æ¬¡çš„ç»“æœéƒ½æ˜¯ä¸ä¸€å®šçš„ï¼Œç„¶åæˆ‘å¼€äº†æ˜¾ç¤ºæ¨¡å¼ï¼Œé‡Œé¢çš„æµ‹è¯•ç”»é¢å’Œç»“æœä¼šè¢«æ˜¾ç¤ºå’Œæ‰“å°ï¼Œå‰é¢çš„é€Ÿåº¦ä¼šæ¯”åé¢çš„å¿«ï¼Œå› ä¸ºåˆ†æ•°ä½æ—¶é—´è‡ªç„¶å°±çŸ­äº†ã€‚
æ›´æ®è¿™æ®µæ—¶é—´å¯¹æ·±åº¦å­¦ä¹ çš„å­¦ä¹ ï¼ŒåŸºæœ¬ä¸Šä»£ç è¿è¡Œæ²¡æœ‰é—®é¢˜åé‚£ä¹ˆè°ƒæ•´å‡ ä¸ªè¶…å‚åŸºæœ¬ä¸Šå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ‹Ÿåˆæ•ˆæœã€‚


# å¿ƒå¾—ä½“ä¼š
æœ¬æ¬¡â€œçˆ¬å±±â€ï¼Œå‘ç°ä¹‹å‰çš„ä¸€äº›ç›²ç‚¹åœ¨æœ¬æ¬¡æœ‰äº†è§£å†³ï¼Œï¼Œä¹‹å‰å¯¹æ·±åº¦å­¦ä¹ ã€PARLã€ç®—æ³•ç­‰éƒ½æœ‰äº†æœ€æ–°çš„è®¤è¯†ï¼Œè™½ç„¶è¿˜æ˜¯é‚£ä¸ªå°ç™½ä½†æ˜¯è®¤è¯†æä¸Šå»äº†ï¼Œä»¥åè¿˜æ˜¯å¯ä»¥æ›´åŠ åŠªåŠ›çš„å»å¥‹æ–—çš„ï¼Œè¿™å°±æ˜¯ä¼ è¯´ä¸­çš„å›å¤´çœ‹çš„æ—¶å€™å°±çŸ¥é“è‡ªå·±ä»¥å‰æ˜¯å¤šä¹ˆçš„æ— çŸ¥äº†ã€‚

# è¿™é‡Œæ˜¯ä¸‰å²ï¼Œè¯·å¤§å®¶å¤šå¤šæŒ‡æ•™å•Šï¼
